

## Giải Pháp Blackjack - Phần 3: Logic Kết Thúc Game và Testing

### Bước 6: Tổ Chức Lại Code

**Nguyên tắc quan trọng:** Hàm phải được khai báo (declare) trước khi gọi (call).

**Lỗi thường gặp:**

```python
# SAI - Gọi hàm trước khi khai báo
user_score = calculate_score(user_cards)

def calculate_score(cards):
    return sum(cards)
```

**Cách đúng:**

```python
# ĐÚNG - Khai báo hàm trước
def calculate_score(cards):
    """Take a list of cards and return the score calculated from the cards"""
    if sum(cards) == 21 and len(cards) == 2:
        return 0
    if 11 in cards and sum(cards) > 21:
        cards.remove(11)
        cards.append(1)
    return sum(cards)

# Chia bài
for _ in range(2):
    user_cards.append(deal_card())
    computer_cards.append(deal_card())

# Bây giờ mới gọi hàm
user_score = calculate_score(user_cards)
```


### Bước 7: Tính Điểm Sau Khi Chia Bài

Sau khi chia bài xong, cần tính điểm ngay lập tức để kiểm tra các điều kiện kết thúc game.

```python
# Tính điểm cho cả hai bên
user_score = calculate_score(user_cards)
computer_score = calculate_score(computer_cards)
```

**Giá trị trả về có thể:**

- `0`: Đại diện cho Blackjack (21 với 2 lá)
- `1-21`: Tổng điểm thực tế của các lá bài
- `> 21`: Bust (vượt quá 21)


### Bước 8: Theo Dõi Trạng Thái Game

**Tạo biến boolean để theo dõi:**

```python
is_game_over = False
```

**Điều kiện kết thúc game:**

```python
if user_score == 0 or computer_score == 0 or user_score > 21:
    is_game_over = True
```

**Các trường hợp kết thúc:**

- User có Blackjack (score = 0)
- Computer có Blackjack (score = 0)
- User bị Bust (score > 21)

**Lý do thiết kế:**

- Biến `is_game_over` giúp kiểm soát luồng chương trình
- Ban đầu `False` - game tiếp tục
- Khi điều kiện thỏa mãn → `True` - game kết thúc
- Sẽ sử dụng biến này ở các bước tiếp theo


### Bước 9: Hiển Thị Thông Tin và Testing

**Mục đích testing:** Kiểm tra code hoạt động đúng trước khi tiếp tục phát triển.

**Thêm print statements:**

```python
print(f"Your cards: {user_cards}, current score: {user_score}")
print(f"Computer's first card: {computer_cards[0]}")
```

**Giải thích cú pháp:**

- `f-string`: Cho phép chèn biến trực tiếp vào chuỗi
- `{user_cards}`: Hiển thị toàn bộ danh sách bài của user
- `{computer_cards[0]}`: Chỉ hiển thị lá bài đầu tiên của computer
- `[0]`: Index (chỉ số) để truy xuất phần tử đầu tiên trong list

**Tại sao chỉ hiển thị 1 lá của computer?**

- Theo luật Blackjack, dealer chỉ lật 1 lá bài ban đầu
- Lá thứ hai được giữ kín (face-down)
- Tạo yếu tố bí ẩn và chiến thuật cho game


### Kết Quả Testing

**Ví dụ output:**

```
Your cards: [3, 2], current score: 5
Computer's first card: 4
```

**Phân tích:**

- User nhận 2 lá: 3 và 2
- Tổng điểm: 3 + 2 = 5
- Computer hiển thị lá đầu: 4
- Code hoạt động chính xác


### Mã Nguồn Hoàn Chỉnh Đến Bước Này

```python
import random

def deal_card():
    """Returns a random card from the deck."""
    cards = [11, 2, 3, 4, 5, 6, 7, 8, 9, 10, 10, 10, 10]
    return random.choice(cards)

def calculate_score(cards):
    """Take a list of cards and return the score calculated from the cards"""
    if sum(cards) == 21 and len(cards) == 2:
        return 0
    if 11 in cards and sum(cards) > 21:
        cards.remove(11)
        cards.append(1)
    return sum(cards)

# Khởi tạo
user_cards = []
computer_cards = []
is_game_over = False

# Chia 2 lá cho mỗi bên
for _ in range(2):
    user_cards.append(deal_card())
    computer_cards.append(deal_card())

# Tính điểm
user_score = calculate_score(user_cards)
computer_score = calculate_score(computer_cards)

# Kiểm tra điều kiện kết thúc
if user_score == 0 or computer_score == 0 or user_score > 21:
    is_game_over = True

# Hiển thị thông tin (testing)
print(f"Your cards: {user_cards}, current score: {user_score}")
print(f"Computer's first card: {computer_cards[0]}")
```


### Thực Hành Tốt: Testing Thường Xuyên

**Lợi ích của testing sớm:**

- Phát hiện lỗi khi code còn đơn giản
- Dễ dàng xác định vị trí lỗi
- Tránh debug phức tạp khi code đã dài
- Đảm bảo từng phần hoạt động đúng trước khi tiếp tục

**Quy trình phát triển đề xuất:**

1. Viết một phần code nhỏ
2. Test ngay lập tức
3. Xác nhận hoạt động đúng
4. Tiếp tục phát triển phần tiếp theo

### Ghi Chú Thêm

**Về việc tổ chức code:**

- Các hàm nên được đặt ở đầu file
- Sau đó mới đến phần code thực thi chính
- Giúp code dễ đọc và bảo trì

**Về biến is_game_over:**

- Flag variable (biến cờ) để kiểm soát luồng
- Pattern phổ biến trong lập trình game
- Sẽ được sử dụng trong vòng lặp ở bước tiếp theo

**Liên kết:** [[is_game_over]], [[Boolean Variable]], [[f-string]], [[List Indexing]], [[Testing]], [[Debugging]], [[Game State]], [[Flag Variable]], [[Code Organization]], [[Print Debugging]]

