

## Tổ chức Code với Snake Class - Refactoring

### Mục tiêu refactoring

Tách tất cả logic liên quan đến rắn vào một class riêng biệt để:

- Code dễ bảo trì và mở rộng
- Tổ chức theo nguyên tắc **Single Responsibility Principle** (mỗi class chỉ quản lý một nhiệm vụ)
- Dự án cuối cùng sẽ có 3 class: `Snake`, `Food`, `Scoreboard`

**Kết quả mong đợi trong main.py:**

```python
from snake import Snake

snake = Snake()

while game_is_on:
    screen.update()
    time.sleep(0.1)
    snake.move()
```


### Tạo file snake.py

#### Cấu trúc Snake Class

```python
from turtle import Turtle

STARTING_POSITIONS = [(0, 0), (-20, 0), (-40, 0)]
MOVE_DISTANCE = 20

class Snake:
    
    def __init__(self):
        self.segments = []
        self.create_snake()
    
    def create_snake(self):
        for position in STARTING_POSITIONS:
            segment = Turtle("square")
            segment.color("white")
            segment.penup()
            segment.goto(position)
            self.segments.append(segment)
    
    def move(self):
        for seg_num in range(len(self.segments) - 1, 0, -1):
            new_x = self.segments[seg_num - 1].xcor()
            new_y = self.segments[seg_num - 1].ycor()
            self.segments[seg_num].goto(new_x, new_y)
        self.segments[0].forward(MOVE_DISTANCE)
```


### Constants (hằng số)

**Quy tắc đặt tên:**

- Viết HOA toàn bộ: `STARTING_POSITIONS`, `MOVE_DISTANCE`
- Dùng snake_case cho tên gồm nhiều từ: `STARTING_POSITIONS`
- Đặt ở đầu file, bên ngoài class

**Lợi ích:**

- Dễ điều chỉnh thông số game mà không cần sửa code logic
- Tập trung các giá trị cấu hình ở một nơi
- Code dễ đọc hơn với tên có ý nghĩa


### Phương thức __init__()

```python
def __init__(self):
    self.segments = []
    self.create_snake()
```

**Chức năng:**

- Được gọi tự động khi tạo object mới: `snake = Snake()`
- Khởi tạo thuộc tính `segments` - list chứa các phần thân rắn
- Gọi `create_snake()` để tạo rắn ngay khi object được khởi tạo


### Phương thức create_snake()

```python
def create_snake(self):
    for position in STARTING_POSITIONS:
        segment = Turtle("square")
        segment.color("white")
        segment.penup()
        segment.goto(position)
        self.segments.append(segment)
```

**Vai trò:**

- Tạo 3 segments ban đầu cho rắn
- Mỗi segment là một Turtle object hình vuông màu trắng
- Thêm segments vào `self.segments` list


### Phương thức move()

```python
def move(self):
    for seg_num in range(len(self.segments) - 1, 0, -1):
        new_x = self.segments[seg_num - 1].xcor()
        new_y = self.segments[seg_num - 1].ycor()
        self.segments[seg_num].goto(new_x, new_y)
    self.segments[0].forward(MOVE_DISTANCE)
```

**Cơ chế:**

- Di chuyển từng segment từ cuối lên đầu
- Mỗi segment di chuyển đến vị trí của segment trước nó
- Segment đầu (head) di chuyển forward theo hướng hiện tại


### File main.py sau refactoring

```python
from turtle import Screen
from snake import Snake
import time

screen = Screen()
screen.setup(width=600, height=600)
screen.bgcolor("black")
screen.title("My Snake Game")
screen.tracer(0)

snake = Snake()

game_is_on = True
while game_is_on:
    screen.update()
    time.sleep(0.1)
    snake.move()

screen.exitonclick()
```


### So sánh trước và sau refactoring

**Trước:**

- Tất cả code trong main.py
- Khó bảo trì khi project phức tạp
- Khó tái sử dụng code

**Sau:**

- Main.py chỉ quản lý game loop và screen setup
- Snake class quản lý tất cả hành vi của rắn
- Code modular, dễ mở rộng
- Dễ debug khi có lỗi liên quan đến rắn


### Nguyên tắc tổ chức code

**Single Responsibility Principle:**

- Mỗi class chỉ chịu trách nhiệm một chức năng
- Snake class: quản lý rắn
- Screen: quản lý màn hình
- Main: điều phối game loop

**Separation of Concerns:**

- Tách biệt logic theo chức năng
- Dễ tìm và sửa lỗi
- Dễ thêm tính năng mới


### Xử lý lỗi khi dừng game

Khi nhấn Stop button, có thể thấy lỗi trong console:

```
KeyboardInterrupt
Traceback...
```

**Đây là lỗi bình thường** vì:

- Game chưa có cơ chế game over
- While loop chạy vô hạn
- Stop button buộc dừng chương trình đột ngột
- Sẽ được xử lý trong các bài sau


### Kiểm tra kết quả

Chương trình hoạt động đúng nếu:

- Rắn xuất hiện với 3 segments
- Rắn di chuyển tự động và liên tục
- Main.py ngắn gọn, dễ đọc
- Tất cả logic rắn nằm trong Snake class


### Lợi ích của cấu trúc này

- **Scalability** - Dễ thêm Food class, Scoreboard class sau này
- **Maintainability** - Biết đâu là nơi sửa khi có lỗi
- **Reusability** - Có thể tái sử dụng Snake class cho project khác
- **Readability** - Code rõ ràng, dễ hiểu với người đọc mới


### Thuật ngữ quan trọng

- **Refactoring (tái cấu trúc)** - Cải thiện cấu trúc code mà không thay đổi chức năng
- **Class attribute** - Thuộc tính của class, truy cập qua `self`
- **Method** - Hàm được định nghĩa trong class
- **Constant** - Giá trị không thay đổi, viết HOA
- **Pascal Case** - Quy tắc đặt tên class: `SnakeGame`, `FoodItem`

**Liên kết:** [[Object Oriented Programming]], [[Python Class]], [[Refactoring]], [[Single Responsibility Principle]], [[Class Methods]], [[Class Attributes]], [[Constants in Python]], [[Code Organization]], [[Modularity]]

